<meta charset="UTF-8" />
<style>
    * {
        margin: 0;
        padding: 0;
    }
    html,
    body {
        overflow: hidden;
        background: black;
    }
    canvas {
        display: block;
        width: 800px;
        height: 600px;
        border-radius: 10px;
    }
    #controls {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        color: white;
        font-size: 32px;
        font-family: sans-serif;
        pointer-events: none;
        user-select: none;
        text-shadow: 2px 2px 5px black;
    }
    #saveBtn {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 10;
        font-size: 18px;
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        background: white;
        cursor: pointer;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>

<div id="controls">Loading...</div>
<button id="saveBtn">Save as PNG</button>

<script>
    const utils = {
        async hash(message) {
            const data = new TextEncoder().encode(message);
            const buf = await crypto.subtle.digest("SHA-256", data);
            return Array.from(new Uint8Array(buf)).map((b) => b / 255);
        },

        drawStripes(width, height) {
            for (let i = 0; i < width; i++) {
                let amt = (i / width) * 3 + 0.5;
                amt = sin((amt % 1) * PI);
                stroke(i / width, 1, lerp(0.7, 1, amt));
                line(i, 0, i, height);
            }
            noStroke();
        },

        drawCircles(H, width, height, size) {
            for (let i = 0; i < 100; i++) {
                if (i % 2 === 0) {
                    fill(H[i + 0], H[i + 1], H[i + 2], 0.66);
                } else {
                    fill("white");
                }
                circle(H[i + 0] * width, H[i + 1] * height, H[i + 2] * size);
            }
        },
    };
</script>

<script>
    let g;
    let steps = 100;
    let c;
    const text = "my name is amos";

    function setup() {
        c = createCanvas(windowWidth, windowHeight);
        g = createGraphics(width, height);
        colorMode(HSB, 1, 1, 1);
        g.colorMode(HSB, 1, 1, 1);

        document.getElementById("saveBtn").onclick = () =>
            saveCanvas(c, "output", "png");

        mousePressed(); // trigger initial render
    }

    function draw() {
        if (steps < 100) {
            for (let i = 0; i < height; i++) {
                let a = (i / height) * TAU;
                let x =
                    noise(
                        steps * 100,
                        (cos(a) * height) / 2000.0 + 1000.0,
                        (sin(a) * height) / 200.0 + 1000.0,
                    ) * 100.0;
                g.image(c, x, i, width, 1, 0, i, width, 1);
                g.image(c, x - width, i, width, 1, 0, i, width, 1);
            }

            image(g, 0, 0);

            for (let i = 0; i < width; i++) {
                let a = (i / width) * TAU;
                let y =
                    noise(
                        steps * 100,
                        (cos(a) * width) / 2000.0 + 1000.0,
                        (sin(a) * width) / 200.0 + 1000.0,
                    ) * 100.0;
                g.image(c, i, y, 1, height, i, 0, 1, height);
                g.image(c, i, y - height, 1, height, i, 0, 1, height);
            }

            image(g, 0, 0);
            steps++;
        }
    }

    async function mousePressed(e) {
        resizeCanvas(windowWidth, windowHeight);
        g.resizeCanvas(width, height);
        steps = 0;
        noiseSeed(1);

        utils.drawStripes(width, height);

        let H = await utils.hash(text);
        H = new Array(110).fill(0).map((_, i) => H[i % H.length]);

        utils.drawCircles(H, width, height, 330);

        document.getElementById("controls").textContent = text;
    }
</script>
